if("comments"!=GLOBAL_CONFIG.htmlType&&document.querySelector("#post-comment")){var commentBarrageConfig={maxBarrage:GLOBAL_CONFIG.source.comments.maxBarrage,barrageTime:GLOBAL_CONFIG.source.comments.barrageTime,serverUrl:"",mailMd5:GLOBAL_CONFIG.source.comments.mailMd5,pageUrl:window.location.pathname.replace(/\/page\/\d$/,""),barrageTimer:[],barrageList:[],barrageIndex:0,dom:document.querySelector(".comment-barrage"),use:GLOBAL_CONFIG.source.comments.use};switch(commentBarrageConfig.use){case"twikoo":commentBarrageConfig.serverUrl=GLOBAL_CONFIG.source.twikoo.twikooUrl,commentBarrageConfig.accessToken=GLOBAL_CONFIG.source.twikoo.accessToken;break;case"artalk":commentBarrageConfig.serverUrl=GLOBAL_CONFIG.source.artalk.artalkUrl,commentBarrageConfig.siteName=GLOBAL_CONFIG.source.artalk.siteName;break;case"waline":commentBarrageConfig.serverUrl=GLOBAL_CONFIG.source.waline.serverURL}var commentInterval=null,hoverOnCommentBarrage=!1;function initCommentBarrage(){if("twikoo"==commentBarrageConfig.use){var e=JSON.stringify({event:"COMMENT_GET","commentBarrageConfig.accessToken":commentBarrageConfig.accessToken,url:commentBarrageConfig.pageUrl});(a=new XMLHttpRequest).withCredentials=!0,a.addEventListener("readystatechange",(function(){4===this.readyState&&(commentBarrageConfig.barrageList=commentLinkFilter(JSON.parse(this.responseText).data),commentBarrageConfig.dom.innerHTML="")})),a.open("POST",commentBarrageConfig.serverUrl),a.setRequestHeader("Content-Type","application/json"),a.send(e)}if("artalk"==commentBarrageConfig.use){var a;e={site_name:commentBarrageConfig.siteName,page_key:commentBarrageConfig.pageUrl,limit:100,offset:0};(a=new XMLHttpRequest).withCredentials=!0,a.addEventListener("readystatechange",(function(){4===this.readyState&&(commentBarrageConfig.barrageList=commentLinkFilter(JSON.parse(this.responseText).data.comments),commentBarrageConfig.dom.innerHTML="")}));const r=new URLSearchParams(e).toString();a.open("POST",commentBarrageConfig.serverUrl+"api/get"),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.send(r)}"waline"==commentBarrageConfig.use&&fetch(commentBarrageConfig.serverUrl+`/comment?path=${commentBarrageConfig.pageUrl}&pageSize=100&page=1&lang=zh-CN&sortBy=insertedAt_desc`).then((e=>e.json())).then((({data:e})=>{e.length>0&&(commentBarrageConfig.barrageList=commentLinkFilter(e),commentBarrageConfig.dom.innerHTML="")})),clearInterval(commentInterval),commentInterval=null,commentInterval=setInterval((()=>{commentBarrageConfig.barrageList.length&&!hoverOnCommentBarrage&&(popCommentBarrage(commentBarrageConfig.barrageList[commentBarrageConfig.barrageIndex]),commentBarrageConfig.barrageIndex+=1,commentBarrageConfig.barrageIndex%=commentBarrageConfig.barrageList.length),commentBarrageConfig.barrageTimer.length>(commentBarrageConfig.barrageList.length>commentBarrageConfig.maxBarrage?commentBarrageConfig.maxBarrage:commentBarrageConfig.barrageList.length)&&!hoverOnCommentBarrage&&removeCommentBarrage(commentBarrageConfig.barrageTimer.shift())}),commentBarrageConfig.barrageTime)}function commentLinkFilter(e){let a=[];return"Twikoo"==commentBarrageConfig.use&&(e.sort(((e,a)=>e.created-a.created)),e.forEach((e=>{a.push(...getCommentReplies(e))}))),"Artalk"==commentBarrageConfig.use&&(e.sort(((e,a)=>Date.parse(e.date)-Date.parse(a.date))),e.forEach((e=>{a.push(e)}))),"Waline"==commentBarrageConfig.use&&(e.sort(((e,a)=>e.time-a.time)),e.forEach((e=>{a.push(...getCommentWalineReplies(e))}))),a}function getCommentReplies(e){if(e.replies){let a=[e];return e.replies.forEach((e=>{a.push(...getCommentReplies(e))})),a}return[]}function getCommentWalineReplies(e){if(e.children){let a=[e];return e.children.forEach((e=>{a.push(...getCommentReplies(e))})),a}return[]}function popCommentBarrage(e){let a="Twikoo"==commentBarrageConfig.use,r="Artalk"==commentBarrageConfig.use,t="Waline"==commentBarrageConfig.use,n=e.nick,o=a?`https://cravatar.cn/avatar/${e.mailMd5}`:r?`https://cravatar.cn/avatar/${e.email_encrypted}?d=mp&s=240`:t?e.avatar:"https://cravatar.cn/avatar/",m=a?e.mailMd5===commentBarrageConfig.mailMd5:r?e.email_encrypted===commentBarrageConfig.mailMd5:!!t&&"administrator"===e.type,i=a?e.id:r?"atk-comment-"+e.id:t?e.objectId:"post-comment",c=a?e.comment:r?e.content:t?e.comment:"",g=r?e.badge_name:"博主",s=m?""!=g?g:"博主":"热评",l=document.createElement("div");commentBarrageConfig.dom.clientWidth,commentBarrageConfig.dom.clientHeight;l.className="comment-barrage-item",l.innerHTML=`\n        <div class="barrageHead">\n        <a class="barrageTitle\n        ${m?"barrageBloggerTitle":""}" href="javascript:wjx.scrollTo('post-comment')">\n        ${s}\n        </a>\n        <div class="barrageNick">${n}</div>\n        <img class="barrageAvatar" src="${o}" loading="lazy"/>\n        <a class="comment-barrage-close" href="javascript:wjx.switchCommentBarrage()"><i class="icon-xmark"></i></a>\n        </div>\n        <a class="barrageContent" href="javascript:wjx.scrollTo('${i}');">${c}</a>\n        `,l.querySelectorAll(".barrageContent pre").forEach((e=>{let a=document.createElement("span");a.innerText="【代码】",e.parentNode.replaceChild(a,e)})),l.querySelectorAll(".barrageContent img").forEach((e=>{if(!e.classList.contains("tk-owo-emotion")){e.style.display="none";let a=document.createElement("span");a.innerText="【图片】",e.parentNode.replaceChild(a,e)}})),commentBarrageConfig.barrageTimer.push(l),commentBarrageConfig.dom.append(l)}function removeCommentBarrage(e){e.className="comment-barrage-item out",setTimeout((()=>{commentBarrageConfig.dom.removeChild(e)}),1e3)}$(".comment-barrage").hover((function(){hoverOnCommentBarrage=!0}),(function(){hoverOnCommentBarrage=!1})),initCommentBarrage(),"false"!==localStorage.getItem("commentBarrageSwitch")?($(".comment-barrage").show(),$(".menu-commentBarrage-text").text("关闭热评"),document.querySelector("#consoleCommentBarrage").classList.add("on")):($(".comment-barrage").hide(),$(".menu-commentBarrage-text").text("显示热评"),document.querySelector("#consoleCommentBarrage").classList.remove("on")),document.addEventListener("pjax:send",(function(){clearInterval(commentInterval)}))}