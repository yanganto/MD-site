function runPostAbstract(){if(!document.querySelector("#post #article-container"))return;let t,e=GLOBAL_CONFIG.source.postAi.ai,n=GLOBAL_CONFIG.source.postAi.randomNum,o=GLOBAL_CONFIG.source.postAi.basicWordCount,r=GLOBAL_CONFIG.source.postAi.btnLink,i=GLOBAL_CONFIG.source.postAi.gptName,l=GLOBAL_CONFIG.source.postAi.modeName,a=GLOBAL_CONFIG.source.postAi.switchBtn,c=GLOBAL_CONFIG.source.postAi.keys,s=GLOBAL_CONFIG.source.postAi.Referers,d=-1,m=!0,u=l,h=0;const y=document.querySelector(".abstract-title .icon-arrow-rotate-right"),f=document.querySelector("#abstract-content"),g=document.querySelector("#abstract-content");let p="",T="",b=600,A=0,L=0,M=[],G=0;const I=t=>{if(m)if(I.start||(I.start=t),G=t-I.start,G>=20){if(I.start=t,A<T-1){let t=p.charAt(A+1),e=/[,.，。!?！？]/.test(t)?150:20;f.firstElementChild&&f.removeChild(f.firstElementChild),f.innerHTML+=t;let n=document.createElement("div");n.className="ai-cursor",f.appendChild(n),A++,150===e&&(document.querySelector("#abstract-content .ai-cursor").style.opacity="0"),A===T-1&&(E.disconnect(),f.removeChild(f.firstElementChild)),M[0]=setTimeout((()=>{requestAnimationFrame(I)}),e)}}else requestAnimationFrame(I)},E=new IntersectionObserver((t=>{let e=t[0].isIntersecting;m=e,m&&(b=0===A?200:20,M[1]=setTimeout((()=>{L&&(A=0,L=0),0===A&&(f.innerHTML=p.charAt(0)),requestAnimationFrame(I)}),b))}),{threshold:0});function v(){M.length&&M.forEach((t=>{t&&clearTimeout(t)}))}function O(t,e=!0){A=0,L=1,v(),m=!1,G=0,E.disconnect(),f.innerHTML=e?"生成中. . .":"请等待. . .",p=t,T=p.length,E.observe(g)}async function B(t=o){if(A=0,L=1,v(),m=!1,G=0,E.disconnect(),"tianli"===u){t=Math.max(10,Math.min(2e3,t));const e={key:c,Referer:s},n=S(t),o={key:e.key,content:n,url:location.href},r={method:"POST",headers:{"Content-Type":"application/json",Referer:e.Referer},body:JSON.stringify(o)};try{let t=null;t&&clearInterval(t),t=setInterval((()=>{const t="生成中"+".".repeat(L);f.innerHTML=t,L=L%3+1}),500);const e=await fetch("https://summary.tianli0.top/",r);let n;n=403===e.status?{summary:"403 refer与key不匹配，本地无法显示。"}:500===e.status?{summary:"500 系统内部错误"}:await e.json();const o=n.summary.trim();setTimeout((()=>{y.style.opacity="1"}),300),O(o||"摘要获取失败!!!请检查Tianli服务是否正常!!!"),clearInterval(t)}catch(t){console.error(t),f.innerHTML="发生异常"+t}}else{const t=e.split(",").map((t=>t.trim()));if(1!==t.length){let e=Math.floor(Math.random()*t.length);for(;e===d;)e=Math.floor(Math.random()*t.length);d=e,O(t[e])}else O(t[0]);setTimeout((()=>{y.style.opacity="1"}),600)}}const k=document.querySelectorAll(".abstract-btn-item"),q=[function(){O("tianli"==u?"我是文章辅助AI: TianliGPT，点击下方的按钮，让我生成本文简介、推荐相关文章等。":"我是文章辅助AI: "+i+" GPT，点击下方的按钮，让我生成本文简介、推荐相关文章等。")},function(){y.click()},function(){A=0,L=1,v(),m=!1,G=0,f.innerHTML="生成中. . .",p="",T="",E.disconnect(),M[2]=setTimeout((()=>{f.innerHTML=function(){let t=document.querySelectorAll(".relatedPosts-list a");var e=document.title;let n="",o=0;if(!t.length){const r=document.querySelector(".card-widget.card-recent-post");return r?(t=r.querySelectorAll(".aside-list-item a"),t.length>0&&t.forEach((t=>{t&&(e.includes(t.title)||(o+=1,n+=`<div class="ai-recommend-item"><span class="index">${A+1}：</span><a href="javascript:;" onclick="pjax.loadUrl('${t.href}')" title="${t.title}">${t.title}</a></div>`))})),`很抱歉，无法找到类似的文章，你也可以看看本站最新发布的文章：<br /><div class="ai-recommend">${n}</div>`):""}return t.forEach((t=>{t&&(e.includes(t.title)||(o+=1,n+=`<div class="ai-recommend-item"><span>推荐${o}：</span><a href="javascript:;" onclick="pjax.loadUrl('${t.href}')" title="${t.title}">${t.title}</a></div>`))})),`推荐文章：<br /><div class="ai-recommend">${n}</div>`}()}),600)},function(){O("前往爱发电购买...",!1),M[2]=setTimeout((()=>{pjax.loadUrl("/")}),1e3)}];function C(){document.querySelectorAll(".abstract-btn-item").forEach((t=>{"go-tianli-blog"!==t.id&&(t.style.display="block"),"go-tianli-blog"===t.id&&(t.style.display="none")}))}function S(t){try{const e=document.title,n=document.querySelector("#post #article-container");if(!n)return console.warn("TianliGPT：找不到文章容器。请尝试将引入的代码放入到文章容器之后。如果本身没有打算使用摘要功能可以忽略此提示。"),"";const o=n.getElementsByTagName("p"),r=n.querySelectorAll("h1, h2, h3, h4, h5");let i="";for(let t of r)i+=t.innerText+" ";for(let t of o){i+=t.innerText.replace(/https?:\/\/[^\s]+/g,"")}let l=1e3;"undefined"!==t&&(l=t);return(e+" "+i).slice(0,l)}catch(t){return console.error("TianliGPT错误：可能由于一个或多个错误导致没有正常运行，原因出在获取文章容器中的内容失败，或者可能是在文章转换过程中失败。",t),""}}Array.from(k).filter((t=>"go-tianli-blog"!==t.id)).forEach(((t,e)=>{t.addEventListener("click",(()=>{q[e]()}))})),document.getElementById("abstract-tag").addEventListener("click",(()=>{"tianli"===u?(document.querySelectorAll(".abstract-btn-item").forEach((t=>t.style.display="none")),document.getElementById("go-tianli-blog").style.display="block",O("你好，我是Tianli开发的摘要生成助理TianliGPT，是一个基于GPT-4的生成式AI。我在这里只负责摘要的预生成和显示，你无法与我直接沟通，如果你也需要一个这样的AI摘要接口，可以在下方购买。（暂未开放购买，敬请期待）")):(document.getElementById("go-tianli-blog").style.display="none",O("你好，我是本站摘要生成助理"+i+" GPT，是一个基于GPT-4的生成式AI。我在这里只负责摘要的预生成和显示，你无法与我直接沟通。"))})),y.addEventListener("click",(()=>{const e=S(o);let r=Math.floor(Math.random()*n)+o;for(;r===t||e.length-r===t;)r=Math.floor(Math.random()*n)+o;if(y.style.opacity="0.2",y.style.transitionDuration="0.3s",y.style.transform="rotate("+360*h+"deg)",e.length<=1e3){let o=e.length-Math.floor(Math.random()*n);for(;o===t;)o=e.length-Math.floor(Math.random()*n);B(o),t=o}else B(r),t=r;C(),h++})),document.getElementById("go-tianli-blog").addEventListener("click",(()=>{window.open(r,"_blank")})),a&&document.getElementById("abstract-toggle").addEventListener("click",(()=>{!function(){if("tianli"===u)u="local",document.getElementById("abstract-tag").innerHTML=i+" GPT",(document.getElementById("go-tianli-blog").style.display="block")&&(document.querySelectorAll(".abstract-btn-item").forEach((t=>t.style.display="block")),document.getElementById("go-tianli-blog").style.display="none"),B(o);else{u="tianli",document.getElementById("abstract-tag").innerHTML="Tianli GPT";const e=S(o);let r=Math.floor(Math.random()*n)+o;for(;r===t||e.length-r===t;)r=Math.floor(Math.random()*n)+o;if(y.style.opacity="0.2",y.style.transitionDuration="0.3s",y.style.transform="rotate("+360*h+"deg)",e.length<=1e3){let o=e.length-Math.floor(Math.random()*n);for(;o===t;)o=e.length-Math.floor(Math.random()*n);B(o),t=o}else B(r),t=r;h++}}()})),B(),C()}